{% extends "base.html" %}

{% block title %}Kullanıcı Yönetimi - YouTube Doğrulama Botu{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Kullanıcı Yönetimi</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshUsers()">
                <i class="fas fa-sync-alt"></i> Yenile
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportUsers()">
                <i class="fas fa-download"></i> Dışa Aktar
            </button>
            {% if user_role == 'admin' %}
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#bulkActionModal">
                <i class="fas fa-tasks"></i> Toplu İşlem
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Filtreler -->
<div class="card mb-4">
    <div class="card-body">
        <form id="filterForm" class="row g-3">
            <div class="col-md-2">
                <label for="statusFilter" class="form-label">Durum</label>
                <select class="form-select" id="statusFilter" name="status">
                    <option value="all" {{ 'selected' if current_filters.status == 'all' }}>Tümü</option>
                    {% for key, value in user_statuses.items() %}
                    <option value="{{ key }}" {{ 'selected' if current_filters.status == key }}>{{ value }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="riskFilter" class="form-label">Risk Seviyesi</label>
                <select class="form-select" id="riskFilter" name="risk">
                    <option value="all" {{ 'selected' if current_filters.risk == 'all' }}>Tümü</option>
                    {% for key, value in risk_levels.items() %}
                    <option value="{{ key }}" {{ 'selected' if current_filters.risk == key }}>{{ value.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="sortBy" class="form-label">Sırala</label>
                <select class="form-select" id="sortBy" name="sort_by">
                    <option value="last_activity" {{ 'selected' if current_filters.sort_by == 'last_activity' }}>Son Aktivite</option>
                    <option value="username" {{ 'selected' if current_filters.sort_by == 'username' }}>Kullanıcı Adı</option>
                    <option value="verification_count" {{ 'selected' if current_filters.sort_by == 'verification_count' }}>Doğrulama Sayısı</option>
                    <option value="security_score" {{ 'selected' if current_filters.sort_by == 'security_score' }}>Güvenlik Skoru</option>
                    <option value="risk_level" {{ 'selected' if current_filters.sort_by == 'risk_level' }}>Risk Seviyesi</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="sortOrder" class="form-label">Sıra</label>
                <select class="form-select" id="sortOrder" name="sort_order">
                    <option value="desc" {{ 'selected' if current_filters.sort_order == 'desc' }}>Azalan</option>
                    <option value="asc" {{ 'selected' if current_filters.sort_order == 'asc' }}>Artan</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="searchInput" class="form-label">Arama</label>
                <input type="text" class="form-control" id="searchInput" name="search" 
                       placeholder="Kullanıcı adı veya ID" value="{{ current_filters.search }}">
            </div>
            <div class="col-md-1">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- İstatistikler -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ user_data.stats.total_users }}</h4>
                        <p class="mb-0">Toplam Kullanıcı</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ user_data.stats.status_distribution.verified or 0 }}</h4>
                        <p class="mb-0">Doğrulanmış</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-check fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ user_data.stats.status_distribution.pending or 0 }}</h4>
                        <p class="mb-0">Beklemede</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ user_data.stats.high_risk_count }}</h4>
                        <p class="mb-0">Yüksek Risk</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Kullanıcı Listesi -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list"></i>
            Kullanıcı Listesi 
            <span class="badge bg-secondary">{{ user_data.filtered_count }}/{{ user_data.total_count }}</span>
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        {% if user_role == 'admin' %}
                        <th width="30">
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        {% endif %}
                        <th>Kullanıcı</th>
                        <th>Durum</th>
                        <th>Risk</th>
                        <th>Güvenlik Skoru</th>
                        <th>Doğrulama</th>
                        <th>Son Aktivite</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    {% for user in user_data.users %}
                    <tr id="user-row-{{ user.user_id }}">
                        {% if user_role == 'admin' %}
                        <td>
                            <input type="checkbox" class="form-check-input user-checkbox" value="{{ user.user_id }}">
                        </td>
                        {% endif %}
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    {% if user.manual_verification %}
                                    <i class="fas fa-user-shield text-primary" title="Manuel doğrulama"></i>
                                    {% elif user.is_blacklisted %}
                                    <i class="fas fa-ban text-danger" title="Blacklist"></i>
                                    {% else %}
                                    <i class="fas fa-user text-secondary"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <strong>{{ user.username }}</strong>
                                    <small class="text-muted d-block">ID: {{ user.user_id }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if user.status == 'verified' %}
                            <span class="badge bg-success">Doğrulanmış</span>
                            {% elif user.status == 'pending' %}
                            <span class="badge bg-warning">Beklemede</span>
                            {% elif user.status == 'suspicious' %}
                            <span class="badge bg-danger">Şüpheli</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ user_statuses.get(user.status, user.status) }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{{ user.risk_info.color }}">
                                <i class="{{ user.risk_info.icon }}"></i>
                                {{ user.risk_info.label }}
                            </span>
                            {% if user.flag_count > 0 %}
                            <small class="text-muted d-block">{{ user.flag_count }} flag</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar 
                                            {% if user.security_score >= 80 %}bg-success
                                            {% elif user.security_score >= 60 %}bg-warning
                                            {% else %}bg-danger{% endif %}" 
                                            style="width: {{ user.security_score }}%"></div>
                                    </div>
                                </div>
                                <small class="ms-2">{{ user.security_score }}/100</small>
                            </div>
                        </td>
                        <td>
                            <div>
                                <strong>{{ user.verification_count }}</strong> doğrulama
                                <small class="text-muted d-block">{{ user.total_attempts }} deneme</small>
                            </div>
                        </td>
                        <td>
                            <span title="{{ user.last_activity }}">{{ user.last_activity_formatted }}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary" onclick="viewUser({{ user.user_id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if user_role == 'admin' %}
                                {% if user.status != 'verified' %}
                                <button type="button" class="btn btn-outline-success" onclick="verifyUser({{ user.user_id }}, '{{ user.username }}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-outline-warning" onclick="unverifyUser({{ user.user_id }}, '{{ user.username }}')">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                                {% if not user.is_blacklisted %}
                                <button type="button" class="btn btn-outline-danger" onclick="blacklistUser({{ user.user_id }})">
                                    <i class="fas fa-ban"></i>
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-outline-info" onclick="whitelistUser({{ user.user_id }})">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                                {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Sayfalama -->
{% if user_data.filtered_count > 100 %}
<nav class="mt-3">
    <ul class="pagination justify-content-center">
        <li class="page-item"><a class="page-link" href="#" onclick="loadPage(1)">İlk</a></li>
        <li class="page-item"><a class="page-link" href="#" onclick="loadPage(2)">2</a></li>
        <li class="page-item"><a class="page-link" href="#" onclick="loadPage(3)">3</a></li>
        <li class="page-item"><a class="page-link" href="#" onclick="loadPage(-1)">Son</a></li>
    </ul>
</nav>
{% endif %}

<!-- Toplu İşlem Modal -->
{% if user_role == 'admin' %}
<div class="modal fade" id="bulkActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Toplu İşlem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkActionForm">
                    <div class="mb-3">
                        <label for="bulkAction" class="form-label">İşlem Seçin</label>
                        <select class="form-select" id="bulkAction" name="action" required>
                            <option value="">Seçiniz...</option>
                            <option value="verify">Doğrula</option>
                            <option value="unverify">Doğrulamayı Kaldır</option>
                            <option value="blacklist">Blacklist'e Ekle</option>
                            <option value="whitelist">Whitelist'e Ekle</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bulkReason" class="form-label">Sebep</label>
                        <textarea class="form-control" id="bulkReason" name="reason" rows="3" placeholder="İşlem sebebini yazın..."></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span id="selectedCount">0</span> kullanıcı seçildi.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" onclick="executeBulkAction()">İşlemi Uygula</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Form submit
document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const params = new URLSearchParams(formData);
    window.location.href = '{{ url_for("users.users") }}?' + params.toString();
});

// Checkbox işlemleri
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateSelectedCount();
});

document.querySelectorAll('.user-checkbox').forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
});

function updateSelectedCount() {
    const selected = document.querySelectorAll('.user-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = selected;
}

// Kullanıcı işlemleri
function viewUser(userId) {
    window.location.href = `/users/${userId}`;
}

function verifyUser(userId, username) {
    if (confirm(`${username} kullanıcısını doğrulamak istediğinizden emin misiniz?`)) {
        fetch(`/api/users/${userId}/verify`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: username,
                reason: 'Web panel üzerinden manuel doğrulama'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                location.reload();
            } else {
                showToast('Hata: ' + data.error, 'error');
            }
        });
    }
}

function unverifyUser(userId, username) {
    if (confirm(`${username} kullanıcısının doğrulamasını kaldırmak istediğinizden emin misiniz?`)) {
        fetch(`/api/users/${userId}/unverify`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                reason: 'Web panel üzerinden doğrulama kaldırma'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                location.reload();
            } else {
                showToast('Hata: ' + data.error, 'error');
            }
        });
    }
}

function blacklistUser(userId) {
    const reason = prompt('Blacklist sebebini girin:');
    if (reason) {
        fetch(`/api/users/${userId}/blacklist`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({reason: reason})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                location.reload();
            } else {
                showToast('Hata: ' + data.error, 'error');
            }
        });
    }
}

function whitelistUser(userId) {
    if (confirm('Bu kullanıcıyı whitelist\'e eklemek istediğinizden emin misiniz?')) {
        fetch(`/api/users/${userId}/whitelist`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                location.reload();
            } else {
                showToast('Hata: ' + data.error, 'error');
            }
        });
    }
}

// Toplu işlemler
function executeBulkAction() {
    const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
    const action = document.getElementById('bulkAction').value;
    const reason = document.getElementById('bulkReason').value;
    
    if (selectedUsers.length === 0) {
        showToast('Lütfen en az bir kullanıcı seçin', 'warning');
        return;
    }
    
    if (!action) {
        showToast('Lütfen bir işlem seçin', 'warning');
        return;
    }
    
    if (confirm(`${selectedUsers.length} kullanıcı için ${action} işlemini uygulamak istediğinizden emin misiniz?`)) {
        fetch('/api/users/bulk-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: action,
                user_ids: selectedUsers,
                reason: reason
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                location.reload();
            } else {
                showToast('Hata: ' + data.error, 'error');
            }
        });
    }
}

// Diğer fonksiyonlar
function refreshUsers() {
    location.reload();
}

function exportUsers() {
    fetch('/api/users/export')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const blob = new Blob([JSON.stringify(data.data, null, 2)], {type: 'application/json'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = data.download_filename;
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('Kullanıcı listesi indirildi', 'success');
        } else {
            showToast('Hata: ' + data.error, 'error');
        }
    });
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
{% endblock %}